{% extends "base.html" %}
{% block content %}
<section class="glass-panel">
  <div class="stats">
    <article>
      <p class="label">Total Files</p>
      <h3 id="fileCount">{{ user.file_count }}</h3>
    </article>
    <article>
      <p class="label">Storage Used</p>
      <h3 id="storageUsed">{{ '%.2f' | format(user.total_bytes / (1024*1024)) }} MB</h3>
    </article>
    {% if user.is_admin %}
    <article>
      <a href="/admin-panel" class="btn secondary">Admin Panel</a>
    </article>
    {% endif %}
  </div>
</section>

<section class="glass-panel">
  <h3>Upload File</h3>
  <form id="uploadForm" class="upload-form">
    <div class="drag-drop-area" id="dragDropArea">
      <div class="drag-drop-content">
        <p class="drag-drop-icon">üìÅ</p>
        <p><strong>Drag and drop files here</strong></p>
        <p class="muted">or</p>
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" name="upload" required />
          <label for="fileInput" class="file-label">
            <span id="fileName">Choose a file...</span>
            <span class="btn secondary">Browse</span>
          </label>
        </div>
      </div>
    </div>
    <div id="uploadError" class="error-message" style="display: none;"></div>
    <div id="uploadProgress" style="display: none;">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p class="muted" id="progressText">Uploading...</p>
    </div>
    <button type="submit" class="btn primary" id="uploadBtn">Upload File</button>
  </form>
</section>

<section class="glass-panel">
  <div class="files-header">
    <h3>My Files</h3>
    <div class="files-header-actions">
      <div class="view-toggle">
        <button id="listViewBtn" class="view-btn active" onclick="setViewMode('list')" title="List view">
          <span>‚ò∞</span>
        </button>
        <button id="gridViewBtn" class="view-btn" onclick="setViewMode('grid')" title="Grid view">
          <span>‚äû</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Search and Filters -->
  <div class="search-filters-bar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search files..." class="search-input" />
      <span class="search-icon">üîç</span>
    </div>
    <div class="filters-row">
      <select id="fileTypeFilter" class="filter-select">
        <option value="">All Types</option>
        <option value="image">Images</option>
        <option value="video">Videos</option>
        <option value="audio">Audio</option>
        <option value="document">Documents</option>
        <option value="text">Text Files</option>
      </select>
      <select id="folderFilter" class="filter-select">
        <option value="">All Folders</option>
      </select>
      <select id="sortFilter" class="filter-select">
        <option value="date">Sort by Date</option>
        <option value="name">Sort by Name</option>
        <option value="size">Sort by Size</option>
      </select>
      <button id="favoritesFilter" class="btn secondary small" onclick="toggleFavoritesFilter()">
        ‚≠ê Favorites
      </button>
      <button id="trashFilter" class="btn secondary small" onclick="toggleTrashFilter()">
        üóëÔ∏è Trash
      </button>
    </div>
  </div>
  
  <!-- Bulk Actions Bar (hidden by default) -->
  <div id="bulkActionsBar" class="bulk-actions-bar" style="display: none;">
    <span id="selectedCount">0 files selected</span>
    <div class="bulk-actions">
      <button onclick="bulkDownload()" class="btn secondary small">‚¨áÔ∏è Download</button>
      <button onclick="bulkDelete()" class="btn secondary small">üóëÔ∏è Delete</button>
      <button onclick="bulkMove()" class="btn secondary small">üìÅ Move</button>
      <button onclick="clearSelection()" class="btn secondary small">‚úï Clear</button>
    </div>
  </div>
  
  <div id="filesList" class="files-container list-view">
    <p class="muted">Loading files...</p>
  </div>
</section>

<section class="glass-panel" id="shared">
  <h3>Shared Links</h3>
  <p class="muted" style="margin-bottom: 1rem;">Links you've created to share files</p>
  <div id="sharedLinksList">
    <p class="muted">Loading shared links...</p>
  </div>
</section>

<div id="shareModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="modal-close" onclick="closeShareModal()">&times;</span>
    <h3>Share Link</h3>
    <div class="form-group" style="margin: 1rem 0;">
      <label for="expiryMinutes">Expiry Time (minutes)</label>
      <input type="number" id="expiryMinutes" min="1" max="10080" value="30" style="width: 100%; padding: 0.8rem; border-radius: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: var(--text);" />
      <p class="muted" style="font-size: 0.85rem; margin-top: 0.3rem;">Link will expire after the specified time (max 7 days = 10080 minutes)</p>
    </div>
    <button onclick="createShareLink()" class="btn primary full-width" style="margin-bottom: 1rem;">Generate Share Link</button>
    <div id="shareLinkSection" style="display: none;">
      <p class="muted" id="expiryInfo"></p>
      <div class="share-link-box">
        <input type="text" id="shareLinkInput" readonly />
        <button onclick="copyShareLink()" class="btn primary">Copy</button>
      </div>
      <p id="copyStatus" class="success-message" style="display: none;">Link copied!</p>
    </div>
  </div>
</div>

<script>
function getToken() {
  return localStorage.getItem('access_token') || 
         document.cookie.split('; ').find(row => row.startsWith('access_token='))?.split('=')[1] || 
         '';
}

function logout() {
  localStorage.removeItem('access_token');
  document.cookie = 'access_token=; path=/; max-age=0';
  window.location.href = '/login';
}

// Drag and drop functionality
const dragDropArea = document.getElementById('dragDropArea');
const fileInput = document.getElementById('fileInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dragDropArea.addEventListener(eventName, preventDefaults, false);
  document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
  dragDropArea.addEventListener(eventName, () => {
    dragDropArea.classList.add('drag-over');
  }, false);
});

['dragleave', 'drop'].forEach(eventName => {
  dragDropArea.addEventListener(eventName, () => {
    dragDropArea.classList.remove('drag-over');
  }, false);
});

dragDropArea.addEventListener('drop', (e) => {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files.length > 0) {
    fileInput.files = files;
    const fileName = files[0].name;
    document.getElementById('fileName').textContent = fileName;
  }
}, false);

// File input display
fileInput.addEventListener('change', (e) => {
  const fileName = e.target.files[0]?.name || 'Choose a file...';
  document.getElementById('fileName').textContent = fileName;
});

// Upload form
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  
  if (!file) {
    showError('uploadError', 'Please select a file');
    return;
  }
  
  const formData = new FormData();
  formData.append('upload', file);
  
  const errorDiv = document.getElementById('uploadError');
  const progressDiv = document.getElementById('uploadProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const uploadBtn = document.getElementById('uploadBtn');
  
  errorDiv.style.display = 'none';
  progressDiv.style.display = 'block';
  uploadBtn.disabled = true;
  progressFill.style.width = '0%';
  
  try {
    const token = getToken();
    const response = await fetch('/files/upload', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Upload failed');
    }
    
    progressFill.style.width = '100%';
    progressText.textContent = 'Upload complete!';
    
    // Reset form and reload files
    fileInput.value = '';
    document.getElementById('fileName').textContent = 'Choose a file...';
    setTimeout(() => {
      progressDiv.style.display = 'none';
      uploadBtn.disabled = false;
      loadFiles();
      refreshUserStats();
    }, 1000);
  } catch (error) {
    progressDiv.style.display = 'none';
    uploadBtn.disabled = false;
    showError('uploadError', error.message);
  }
});

function showError(elementId, message) {
  const errorDiv = document.getElementById(elementId);
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

// Global state
let selectedFiles = new Set();
let currentFilters = {
  search: '',
  fileType: '',
  folderId: null,
  favoriteOnly: false,
  trashed: false,
  sortBy: 'date'
};

// Load files list with filters
async function loadFiles() {
  const filesList = document.getElementById('filesList');
  filesList.innerHTML = '<p class="muted">Loading files...</p>';
  
  try {
    const token = getToken();
    const params = new URLSearchParams();
    if (currentFilters.search) params.append('search', currentFilters.search);
    if (currentFilters.fileType) params.append('file_type', currentFilters.fileType);
    if (currentFilters.folderId) params.append('folder_id', currentFilters.folderId);
    if (currentFilters.favoriteOnly) params.append('favorite_only', 'true');
    if (currentFilters.trashed) params.append('trashed', 'true');
    params.append('sort_by', currentFilters.sortBy);
    
    const response = await fetch(`/files/?${params.toString()}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
      throw new Error('Failed to load files');
    }
    
    const files = await response.json();
    
    if (files.length === 0) {
      filesList.innerHTML = '<p class="muted">No files found. Try adjusting your filters.</p>';
      return;
    }
    
    const viewMode = localStorage.getItem('viewMode') || 'list';
    renderFiles(files, viewMode);
    updateBulkActionsBar();
  } catch (error) {
    filesList.innerHTML = `<p class="error-message">Error loading files: ${error.message}</p>`;
  }
}

// Refresh header stats from /auth/me
async function refreshUserStats() {
  try {
    const token = getToken();
    const response = await fetch('/auth/me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
      return;
    }

    const me = await response.json();
    const fileCountEl = document.getElementById('fileCount');
    const storageUsedEl = document.getElementById('storageUsed');

    if (fileCountEl) {
      fileCountEl.textContent = me.file_count;
    }
    if (storageUsedEl) {
      const mb = (me.total_bytes / (1024 * 1024)).toFixed(2);
      storageUsedEl.textContent = `${mb} MB`;
    }
  } catch (error) {
    // Ignore errors here; dashboard will still work
  }
}

async function downloadFile(fileId) {
  try {
    const token = getToken();
    const response = await fetch(`/files/${fileId}/download`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
      throw new Error('Failed to get download link');
    }
    
    const data = await response.json();
    window.open(data.url, '_blank');
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

let currentShareFileId = null;

function shareFile(fileId) {
  currentShareFileId = fileId;
  document.getElementById('shareModal').style.display = 'flex';
  document.getElementById('shareLinkSection').style.display = 'none';
  document.getElementById('expiryMinutes').value = '30';
}

async function createShareLink() {
  if (!currentShareFileId) return;
  
  const minutes = parseInt(document.getElementById('expiryMinutes').value) || 30;
  
  if (minutes < 1 || minutes > 10080) {
    alert('Expiry time must be between 1 and 10080 minutes (7 days)');
    return;
  }
  
  try {
    const token = getToken();
    const response = await fetch(`/files/${currentShareFileId}/share?minutes=${minutes}`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Failed to create share link');
    }
    
    const data = await response.json();
    const shareUrl = `${window.location.origin}/shared/${data.token}`;
    
    document.getElementById('shareLinkInput').value = shareUrl;
    document.getElementById('shareLinkSection').style.display = 'block';
    
    const expiryDate = new Date(data.expires_at);
    document.getElementById('expiryInfo').textContent = `Link expires on ${expiryDate.toLocaleString()}`;
    
    // Refresh shared links list
    loadSharedLinks();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

async function deleteFile(fileId, filename) {
  if (!confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
    return;
  }
  
  try {
    const token = getToken();
    const response = await fetch(`/files/${fileId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Failed to delete file');
    }
    
    // Reload files list
    loadFiles();
    refreshUserStats();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

function closeShareModal() {
  document.getElementById('shareModal').style.display = 'none';
  document.getElementById('copyStatus').style.display = 'none';
  document.getElementById('shareLinkSection').style.display = 'none';
  currentShareFileId = null;
}

function copyShareLink() {
  const input = document.getElementById('shareLinkInput');
  input.select();
  document.execCommand('copy');
  
  const status = document.getElementById('copyStatus');
  status.style.display = 'block';
  setTimeout(() => {
    status.style.display = 'none';
  }, 2000);
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Load files and stats on page load
let currentViewMode = localStorage.getItem('viewMode') || 'list';

function setViewMode(mode) {
  currentViewMode = mode;
  localStorage.setItem('viewMode', mode);
  
  const filesList = document.getElementById('filesList');
  filesList.className = `files-container ${mode}-view`;
  
  document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
  document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
  
  // Re-render files with new view mode
  loadFiles();
}

function renderFiles(files, viewMode) {
  const filesList = document.getElementById('filesList');
  
  if (viewMode === 'grid') {
    filesList.innerHTML = files.map(file => `
      <div class="file-card" data-file-id="${file.id}">
        <div class="file-card-checkbox">
          <input type="checkbox" class="file-checkbox" value="${file.id}" onchange="toggleFileSelection(${file.id})" ${selectedFiles.has(file.id) ? 'checked' : ''}>
        </div>
        <div class="file-card-icon">${getFileIcon(file.filename, file.content_type)}</div>
        <div class="file-card-name" title="${escapeHtml(file.filename)}">${escapeHtml(file.filename)}</div>
        <div class="file-card-meta">
          <span class="muted">${formatBytes(file.size)}</span>
          ${file.is_favorite ? '<span class="favorite-badge">‚≠ê</span>' : ''}
        </div>
        <div class="file-card-actions">
          <button onclick="previewFile(${file.id})" class="btn-icon" title="Preview">üëÅÔ∏è</button>
          <button onclick="downloadFile(${file.id})" class="btn-icon" title="Download">‚¨áÔ∏è</button>
          <button onclick="toggleFavorite(${file.id})" class="btn-icon" title="${file.is_favorite ? 'Unfavorite' : 'Favorite'}">${file.is_favorite ? '‚≠ê' : '‚òÜ'}</button>
          <button onclick="shareFile(${file.id})" class="btn-icon" title="Share">üîó</button>
          <button onclick="deleteFile(${file.id}, '${escapeHtml(file.filename)}')" class="btn-icon danger" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  } else {
    filesList.innerHTML = files.map(file => `
      <div class="file-item" data-file-id="${file.id}">
        <div class="file-checkbox-col">
          <input type="checkbox" class="file-checkbox" value="${file.id}" onchange="toggleFileSelection(${file.id})" ${selectedFiles.has(file.id) ? 'checked' : ''}>
        </div>
        <div class="file-info">
          <div class="file-name-row">
            <strong>${escapeHtml(file.filename)}</strong>
            ${file.is_favorite ? '<span class="favorite-badge">‚≠ê</span>' : ''}
          </div>
          <p class="muted">${formatBytes(file.size)} ¬∑ ${formatDate(file.uploaded_at)}</p>
        </div>
        <div class="file-actions">
          <button onclick="previewFile(${file.id})" class="btn secondary small">Preview</button>
          <button onclick="downloadFile(${file.id})" class="btn secondary small">Download</button>
          <button onclick="toggleFavorite(${file.id})" class="btn secondary small">${file.is_favorite ? '‚≠ê' : '‚òÜ'}</button>
          <button onclick="shareFile(${file.id})" class="btn primary small">Share</button>
          <button onclick="deleteFile(${file.id}, '${escapeHtml(file.filename)}')" class="btn danger small">Delete</button>
        </div>
      </div>
    `).join('');
  }
}

function getFileIcon(filename, contentType) {
  const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
  if (contentType && contentType.startsWith('image/')) return 'üñºÔ∏è';
  if (contentType && contentType.startsWith('video/')) return 'üé¨';
  if (contentType && contentType.startsWith('audio/')) return 'üéµ';
  if (ext === '.pdf') return 'üìï';
  if (['.doc', '.docx'].includes(ext)) return 'üìò';
  if (['.xls', '.xlsx'].includes(ext)) return 'üìä';
  if (['.zip', '.rar', '.7z'].includes(ext)) return 'üì¶';
  return 'üìÑ';
}

// Load shared links
async function loadSharedLinks() {
  const sharedLinksList = document.getElementById('sharedLinksList');
  sharedLinksList.innerHTML = '<p class="muted">Loading shared links...</p>';
  
  try {
    const token = getToken();
    const response = await fetch('/files/shares', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
      throw new Error('Failed to load shared links');
    }
    
    const shares = await response.json();
    
    if (shares.length === 0) {
      sharedLinksList.innerHTML = '<p class="muted">No shared links yet. Share a file to create one!</p>';
      return;
    }
    
    sharedLinksList.innerHTML = shares.map((share, index) => {
      const shareUrl = `${window.location.origin}/shared/${share.token}`;
      
      // Parse the date string - FastAPI returns ISO format datetime
      // Pydantic serializes datetime.utcnow() as ISO string without 'Z'
      // We need to treat it as UTC
      let expiresAtStr = share.expires_at;
      
      // If the string doesn't end with 'Z' or timezone offset, treat as UTC
      if (!expiresAtStr.endsWith('Z') && !expiresAtStr.match(/[+-]\d{2}:\d{2}$/)) {
        // Add 'Z' to indicate UTC
        expiresAtStr = expiresAtStr + 'Z';
      }
      
      const expiresAt = new Date(expiresAtStr);
      const now = new Date();
      
      // Compare timestamps - link is expired if expires_at is in the past
      const isExpired = expiresAt.getTime() < now.getTime();
      const statusClass = isExpired ? 'expired' : 'active';
      const statusText = isExpired ? 'Expired' : 'Active';
      
      // Format date nicely in local timezone for display
      const expiresStr = expiresAt.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="share-link-item ${statusClass}" data-share-index="${index}">
          <div class="share-link-info">
            <div class="share-link-url">
              <strong>${escapeHtml(shareUrl)}</strong>
            </div>
            <p class="muted">
              Expires: ${expiresStr} ¬∑ 
              Status: <span class="status-badge ${statusClass}">${statusText}</span>
            </p>
          </div>
          <div class="share-link-actions">
            <button class="btn secondary small copy-share-btn" data-url="${escapeHtml(shareUrl)}">Copy</button>
          </div>
        </div>
      `;
    }).join('');
    
    // Attach copy button handlers using event delegation
    sharedLinksList.addEventListener('click', (e) => {
      if (e.target.classList.contains('copy-share-btn')) {
        const url = e.target.getAttribute('data-url');
        copyShareUrl(url);
      }
    });
  } catch (error) {
    sharedLinksList.innerHTML = `<p class="error-message">Error loading shared links: ${error.message}</p>`;
  }
}

function copyShareUrl(url) {
  if (!url) return;
  
  // Try modern clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(() => {
      showCopyFeedback('Link copied to clipboard!');
    }).catch(() => {
      // Fallback for older browsers
      fallbackCopy(url);
    });
  } else {
    // Fallback for older browsers
    fallbackCopy(url);
  }
}

function fallbackCopy(url) {
  const input = document.createElement('input');
  input.style.position = 'fixed';
  input.style.opacity = '0';
  input.value = url;
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999); // For mobile devices
  
  try {
    document.execCommand('copy');
    showCopyFeedback('Link copied to clipboard!');
  } catch (err) {
    showCopyFeedback('Failed to copy. Please copy manually: ' + url, true);
  }
  
  document.body.removeChild(input);
}

function showCopyFeedback(message, isError = false) {
  // Remove existing feedback if any
  const existing = document.querySelector('.copy-feedback');
  if (existing) existing.remove();
  
  const feedback = document.createElement('div');
  feedback.className = `copy-feedback ${isError ? 'error' : 'success'}`;
  feedback.textContent = message;
  feedback.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${isError ? '#ff6b6b' : '#51cf66'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(feedback);
  
  setTimeout(() => {
    feedback.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => feedback.remove(), 300);
  }, 2000);
}

// Initialize view mode and active nav on page load
document.addEventListener('DOMContentLoaded', () => {
  // Set active nav item
  const currentPath = window.location.pathname;
  document.querySelectorAll('.nav-item').forEach(item => {
    const href = item.getAttribute('href');
    if (href === currentPath || (currentPath === '/' && href === '/')) {
      item.classList.add('active');
    }
  });
  
  // Handle hash anchor (scroll to shared section)
  if (window.location.hash === '#shared') {
    setTimeout(() => {
      const sharedSection = document.getElementById('shared');
      if (sharedSection) {
        sharedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 100);
  }
  
  // Initialize view mode
  setViewMode(currentViewMode);
});

// Search and filter handlers
document.getElementById('searchInput')?.addEventListener('input', (e) => {
  currentFilters.search = e.target.value;
  loadFiles();
});

document.getElementById('fileTypeFilter')?.addEventListener('change', (e) => {
  currentFilters.fileType = e.target.value;
  loadFiles();
});

document.getElementById('sortFilter')?.addEventListener('change', (e) => {
  currentFilters.sortBy = e.target.value;
  loadFiles();
});

function toggleFavoritesFilter() {
  currentFilters.favoriteOnly = !currentFilters.favoriteOnly;
  const btn = document.getElementById('favoritesFilter');
  btn.classList.toggle('active', currentFilters.favoriteOnly);
  loadFiles();
}

function toggleTrashFilter() {
  currentFilters.trashed = !currentFilters.trashed;
  const btn = document.getElementById('trashFilter');
  btn.classList.toggle('active', currentFilters.trashed);
  loadFiles();
}

// Bulk selection
function toggleFileSelection(fileId) {
  if (selectedFiles.has(fileId)) {
    selectedFiles.delete(fileId);
  } else {
    selectedFiles.add(fileId);
  }
  updateBulkActionsBar();
}

function updateBulkActionsBar() {
  const bar = document.getElementById('bulkActionsBar');
  const count = document.getElementById('selectedCount');
  if (selectedFiles.size > 0) {
    bar.style.display = 'flex';
    count.textContent = `${selectedFiles.size} file${selectedFiles.size > 1 ? 's' : ''} selected`;
  } else {
    bar.style.display = 'none';
  }
}

function clearSelection() {
  selectedFiles.clear();
  document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
  updateBulkActionsBar();
}

async function bulkDownload() {
  if (selectedFiles.size === 0) return;
  
  try {
    const token = getToken();
    const response = await fetch('/files/bulk/download', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(Array.from(selectedFiles))
    });
    
    if (!response.ok) throw new Error('Download failed');
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'files.zip';
    a.click();
    window.URL.revokeObjectURL(url);
    
    clearSelection();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

async function bulkDelete() {
  if (selectedFiles.size === 0) return;
  if (!confirm(`Delete ${selectedFiles.size} file(s)? They will be moved to trash.`)) return;
  
  try {
    const token = getToken();
    const response = await fetch('/files/bulk/delete', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(Array.from(selectedFiles))
    });
    
    if (!response.ok) throw new Error('Delete failed');
    
    clearSelection();
    loadFiles();
    refreshUserStats();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

function bulkMove() {
  if (selectedFiles.size === 0) return;
  // TODO: Show folder picker modal
  alert('Folder picker coming soon!');
}

async function toggleFavorite(fileId) {
  try {
    const token = getToken();
    const response = await fetch(`/files/${fileId}/favorite`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) throw new Error('Failed to toggle favorite');
    
    loadFiles();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

async function previewFile(fileId) {
  try {
    const token = getToken();
    const response = await fetch(`/files/${fileId}/preview`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) throw new Error('Failed to get preview');
    
    const data = await response.json();
    
    // Create preview modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
        <h3>${escapeHtml(data.filename)}</h3>
        <div class="preview-container">
          ${data.content_type.startsWith('image/') ? 
            `<img src="${data.url}" style="max-width: 100%; max-height: 70vh;" />` :
            data.content_type.startsWith('video/') ?
            `<video controls style="max-width: 100%; max-height: 70vh;"><source src="${data.url}" type="${data.content_type}"></video>` :
            data.content_type.startsWith('audio/') ?
            `<audio controls style="width: 100%;"><source src="${data.url}" type="${data.content_type}"></audio>` :
            data.content_type === 'application/pdf' ?
            `<iframe src="${data.url}" style="width: 100%; height: 70vh; border: none;"></iframe>` :
            `<p class="muted">Preview not available for this file type.</p>
             <a href="${data.url}" target="_blank" class="btn primary">Open in new tab</a>`
          }
        </div>
        <div style="margin-top: 1rem;">
          <a href="${data.url}" download="${data.filename}" class="btn primary">Download</a>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

// Load folders for filter dropdown
async function loadFolders() {
  try {
    const token = getToken();
    const response = await fetch('/folders/', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (response.ok) {
      const folders = await response.json();
      const select = document.getElementById('folderFilter');
      if (select) {
        select.innerHTML = '<option value="">All Folders</option>' +
          folders.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join('');
      }
    }
  } catch (error) {
    // Ignore errors
  }
}

// Update delete function to support trash
async function deleteFile(fileId, filename) {
  const isTrashed = currentFilters.trashed;
  const action = isTrashed ? 'permanently delete' : 'move to trash';
  
  if (!confirm(`Are you sure you want to ${action} "${filename}"?`)) {
    return;
  }
  
  try {
    const token = getToken();
    const response = await fetch(`/files/${fileId}?permanent=${isTrashed}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Failed to delete file');
    }
    
    loadFiles();
    refreshUserStats();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

loadFiles();
loadSharedLinks();
loadFolders();
refreshUserStats();
</script>
{% endblock %}
