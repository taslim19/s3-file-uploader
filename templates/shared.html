{% extends "base.html" %}
{% block content %}
<section class="shared-file-container">
  <div class="glass-panel shared-file-panel">
    <div id="fileInfo">
      <div class="loading-state">
        <div class="spinner"></div>
        <p class="muted">Loading file information...</p>
      </div>
    </div>
    <div id="errorMsg" class="error-message" style="display: none;"></div>
    <div id="filePreview" style="display: none;">
      <div class="file-preview-content">
        <img id="imagePreview" class="image-preview" alt="Preview" style="display: none;">
        <div id="fileDetails" class="file-details"></div>
      </div>
      <button id="downloadBtn" class="btn primary large full-width" onclick="downloadSharedFile()">
        <span>⬇️</span>
        <span>Download File</span>
      </button>
    </div>
  </div>
</section>

<script>
const token = '{{ token }}';
let downloadUrl = '';
let fileName = '';

// Check if file is an image
function isImageFile(filename) {
  const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.ico'];
  const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
  return imageExtensions.includes(ext);
}

async function loadSharedFile() {
  try {
    const response = await fetch(`/files/shared/${token}`);
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Failed to load file');
    }
    
    const data = await response.json();
    downloadUrl = data.url;
    fileName = data.filename;
    
    const isImage = isImageFile(fileName);
    
    // Hide loading state
    document.getElementById('fileInfo').style.display = 'none';
    
    // Show file preview
    const filePreview = document.getElementById('filePreview');
    filePreview.style.display = 'block';
    
    // Set file details
    const fileDetails = document.getElementById('fileDetails');
    fileDetails.innerHTML = `
      <h2>${escapeHtml(fileName)}</h2>
      <p class="muted">Shared file ready to download</p>
    `;
    
    // If it's an image, show preview
    if (isImage) {
      const imagePreview = document.getElementById('imagePreview');
      imagePreview.src = downloadUrl;
      imagePreview.style.display = 'block';
      imagePreview.onerror = function() {
        // If image fails to load, hide it
        imagePreview.style.display = 'none';
      };
    }
  } catch (error) {
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('errorMsg').textContent = error.message;
    document.getElementById('errorMsg').style.display = 'block';
  }
}

function downloadSharedFile() {
  if (downloadUrl) {
    // Create a temporary anchor element for download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

loadSharedFile();
</script>
{% endblock %}

